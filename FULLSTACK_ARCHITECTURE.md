# ğŸ—ï¸ å…¨æ ˆå•é•œåƒæ¶æ„è¯´æ˜

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜å…¨æ ˆå•é•œåƒç‰ˆæœ¬çš„æ¶æ„è®¾è®¡å’ŒæŠ€æœ¯å®ç°ã€‚

## ğŸ“ æ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Docker å®¹å™¨                               â”‚
â”‚  volcengine-fullstack:latest                                â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              Supervisor (è¿›ç¨‹ç®¡ç†)                      â”‚ â”‚
â”‚  â”‚  - ç®¡ç†å¤šä¸ªè¿›ç¨‹                                         â”‚ â”‚
â”‚  â”‚  - è¿›ç¨‹ç›‘æ§å’Œè‡ªåŠ¨é‡å¯                                    â”‚ â”‚
â”‚  â”‚  - ç»Ÿä¸€æ—¥å¿—ç®¡ç†                                         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚            â”‚                         â”‚                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚   Nginx (80)      â”‚    â”‚  Uvicorn (8000)    â”‚           â”‚
â”‚  â”‚  - å‰ç«¯é™æ€æ–‡ä»¶    â”‚    â”‚  - FastAPI åç«¯     â”‚           â”‚
â”‚  â”‚  - åå‘ä»£ç†        â”‚â—„â”€â”€â”€â”¤  - å›¾åƒç”Ÿæˆ API     â”‚           â”‚
â”‚  â”‚  - Gzip å‹ç¼©      â”‚    â”‚  - ä¸šåŠ¡é€»è¾‘å¤„ç†     â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                  ç«å±±å¼•æ“å›¾åƒ API
```

### è¿›ç¨‹ç®¡ç†

ä½¿ç”¨ **Supervisor** ç®¡ç†å®¹å™¨å†…çš„å¤šä¸ªè¿›ç¨‹ï¼š

1. **Nginx** - å‰ç«¯æœåŠ¡å’Œåå‘ä»£ç†
   - ç«¯å£ï¼š80
   - æœåŠ¡å‰ç«¯é™æ€æ–‡ä»¶
   - åå‘ä»£ç† API è¯·æ±‚åˆ°åç«¯

2. **Uvicorn** - Python ASGI æœåŠ¡å™¨
   - ç«¯å£ï¼š8000ï¼ˆå†…éƒ¨ï¼‰
   - è¿è¡Œ FastAPI åº”ç”¨
   - å¤„ç†å›¾åƒç”Ÿæˆè¯·æ±‚

### ç½‘ç»œé€šä¿¡

```
å¤–éƒ¨è¯·æ±‚ â†’ ç«¯å£3000 (ä¸»æœº) â†’ ç«¯å£80 (å®¹å™¨)
                                  â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                           â”‚
                é™æ€æ–‡ä»¶ (/)              API è¯·æ±‚ (/api)
                    â”‚                           â”‚
                    â–¼                           â–¼
               Nginx ç›´æ¥æœåŠ¡              127.0.0.1:8000
                                              (Uvicorn)
```

## ğŸ”§ æŠ€æœ¯å®ç°

### å¤šé˜¶æ®µæ„å»º

#### é˜¶æ®µ 1ï¼šå‰ç«¯æ„å»º

```dockerfile
FROM node:20-alpine AS frontend-build
WORKDIR /app
COPY frontend/package*.json ./
RUN npm ci --ignore-scripts
COPY frontend/ ./
RUN npm run build
# è¾“å‡ºï¼š/app/dist
```

#### é˜¶æ®µ 2ï¼šæœ€ç»ˆé•œåƒ

```dockerfile
FROM python:3.11-slim

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y \
    nginx supervisor wget curl net-tools

# å®‰è£… Python ä¾èµ–
COPY backend/requirements.txt .
RUN pip install -r requirements.txt

# å¤åˆ¶åº”ç”¨ä»£ç 
COPY backend/app/ ./app/

# å¤åˆ¶å‰ç«¯æ„å»ºäº§ç‰©
COPY --from=frontend-build /app/dist /usr/share/nginx/html

# é…ç½® Nginx å’Œ Supervisor
COPY nginx/nginx.conf.fullstack /etc/nginx/conf.d/default.conf
COPY nginx/nginx-main.conf /etc/nginx/nginx.conf
COPY supervisor/supervisord.conf /etc/supervisor/conf.d/

# å¯åŠ¨ Supervisor
CMD ["/usr/bin/supervisord", "-c", "/etc/supervisor/conf.d/supervisord.conf"]
```

### Nginx é…ç½®

**ä¸»é…ç½®** (`nginx-main.conf`):
- Worker è¿›ç¨‹é…ç½®
- Gzip å‹ç¼©
- æ—¥å¿—è®¾ç½®
- MIME ç±»å‹

**ç«™ç‚¹é…ç½®** (`nginx.conf.fullstack`):
```nginx
server {
    listen 80;
    
    # å‰ç«¯ SPA
    location / {
        root /usr/share/nginx/html;
        try_files $uri $uri/ /index.html;
    }
    
    # åç«¯ API
    location /api/ {
        proxy_pass http://127.0.0.1:8000/api/;
    }
    
    # å¥åº·æ£€æŸ¥
    location /health {
        proxy_pass http://127.0.0.1:8000/health;
    }
}
```

### Supervisor é…ç½®

```ini
[supervisord]
nodaemon=true
logfile=/var/log/supervisor/supervisord.log

[program:uvicorn]
command=uvicorn app.main:app --host 0.0.0.0 --port 8000
directory=/app
autorestart=true
stdout_logfile=/var/log/supervisor/uvicorn.log

[program:nginx]
command=/usr/sbin/nginx -g "daemon off;"
autorestart=true
stdout_logfile=/var/log/supervisor/nginx.log
```

## ğŸ“¦ æ„å»ºè¿‡ç¨‹

### æ„å»ºæµç¨‹

```
1. å‰ç«¯æ„å»ºé˜¶æ®µ
   â”œâ”€â”€ å®‰è£… Node.js ä¾èµ–
   â”œâ”€â”€ æ„å»º Vue åº”ç”¨ (npm run build)
   â””â”€â”€ ç”Ÿæˆé™æ€æ–‡ä»¶åˆ° /app/dist

2. æœ€ç»ˆé•œåƒé˜¶æ®µ
   â”œâ”€â”€ å®‰è£…ç³»ç»ŸåŒ… (nginx, supervisor, å·¥å…·)
   â”œâ”€â”€ å®‰è£… Python ä¾èµ–
   â”œâ”€â”€ å¤åˆ¶åç«¯ä»£ç 
   â”œâ”€â”€ å¤åˆ¶å‰ç«¯æ„å»ºäº§ç‰©
   â”œâ”€â”€ é…ç½® Nginx
   â””â”€â”€ é…ç½® Supervisor

3. å¯åŠ¨
   â””â”€â”€ Supervisor å¯åŠ¨å¹¶ç®¡ç† Nginx å’Œ Uvicorn
```

### æ–‡ä»¶ç»“æ„

```
/                                  # å®¹å™¨å†…æ–‡ä»¶ç³»ç»Ÿ
â”œâ”€â”€ app/                          # åç«¯åº”ç”¨
â”‚   â”œâ”€â”€ app/                      # Python ä»£ç 
â”‚   â”‚   â”œâ”€â”€ main.py
â”‚   â”‚   â”œâ”€â”€ config.py
â”‚   â”‚   â”œâ”€â”€ routers/
â”‚   â”‚   â””â”€â”€ services/
â”‚   â””â”€â”€ data/                     # æ•°æ®ç›®å½•ï¼ˆæŒ‚è½½ç‚¹ï¼‰
â”‚       â””â”€â”€ output/               # ç”Ÿæˆçš„å›¾ç‰‡
â”œâ”€â”€ usr/share/nginx/html/         # å‰ç«¯é™æ€æ–‡ä»¶
â”‚   â”œâ”€â”€ index.html
â”‚   â”œâ”€â”€ assets/
â”‚   â””â”€â”€ ...
â”œâ”€â”€ etc/
â”‚   â”œâ”€â”€ nginx/
â”‚   â”‚   â”œâ”€â”€ nginx.conf           # Nginx ä¸»é…ç½®
â”‚   â”‚   â””â”€â”€ conf.d/
â”‚   â”‚       â””â”€â”€ default.conf     # ç«™ç‚¹é…ç½®
â”‚   â””â”€â”€ supervisor/
â”‚       â””â”€â”€ conf.d/
â”‚           â””â”€â”€ supervisord.conf  # Supervisor é…ç½®
â””â”€â”€ var/log/
    â”œâ”€â”€ nginx/                    # Nginx æ—¥å¿—
    â”‚   â”œâ”€â”€ access.log
    â”‚   â””â”€â”€ error.log
    â””â”€â”€ supervisor/               # Supervisor æ—¥å¿—
        â”œâ”€â”€ supervisord.log
        â”œâ”€â”€ uvicorn.log
        â””â”€â”€ nginx.log
```

## ğŸš€ å¯åŠ¨æµç¨‹

### å®¹å™¨å¯åŠ¨åºåˆ—

```
1. Docker å¯åŠ¨å®¹å™¨
   â†“
2. æ‰§è¡Œ CMD: supervisord
   â†“
3. Supervisor è¯»å–é…ç½®
   â†“
4. Supervisor å¯åŠ¨å­è¿›ç¨‹
   â”œâ”€â”€ å¯åŠ¨ Uvicorn (FastAPI)
   â”‚   â””â”€â”€ ç›‘å¬ 0.0.0.0:8000
   â””â”€â”€ å¯åŠ¨ Nginx
       â””â”€â”€ ç›‘å¬ 0.0.0.0:80
   â†“
5. åº”ç”¨å°±ç»ª
   â””â”€â”€ å¥åº·æ£€æŸ¥é€šè¿‡
```

### å¥åº·æ£€æŸ¥

Docker å¥åº·æ£€æŸ¥ï¼š
```bash
wget --quiet --tries=1 --spider http://localhost:80/health
```

å¥åº·æ£€æŸ¥æµç¨‹ï¼š
```
1. Docker å‘èµ·å¥åº·æ£€æŸ¥
   â†“
2. è¯·æ±‚ http://localhost:80/health
   â†“
3. Nginx æ¥æ”¶è¯·æ±‚
   â†“
4. Nginx åå‘ä»£ç†åˆ° http://127.0.0.1:8000/health
   â†“
5. FastAPI å¤„ç†å¥åº·æ£€æŸ¥
   â†“
6. è¿”å› {"status": "healthy", ...}
```

## ğŸ”„ è¯·æ±‚å¤„ç†æµç¨‹

### å‰ç«¯èµ„æºè¯·æ±‚

```
æµè§ˆå™¨ â†’ http://localhost:3000/
         â†“
Docker ç«¯å£æ˜ å°„ (3000:80)
         â†“
Nginx (ç«¯å£ 80)
         â†“
try_files $uri $uri/ /index.html
         â†“
è¿”å› /usr/share/nginx/html/index.html
```

### API è¯·æ±‚

```
æµè§ˆå™¨ â†’ http://localhost:3000/api/v1/generate/text2image
         â†“
Docker ç«¯å£æ˜ å°„ (3000:80)
         â†“
Nginx (ç«¯å£ 80)
         â†“
location /api/ åŒ¹é…
         â†“
proxy_pass http://127.0.0.1:8000/api/
         â†“
Uvicorn (ç«¯å£ 8000)
         â†“
FastAPI è·¯ç”±å¤„ç†
         â†“
è°ƒç”¨ç«å±±å¼•æ“ API
         â†“
è¿”å›ç”Ÿæˆçš„å›¾ç‰‡
```

## ğŸ“Š èµ„æºä½¿ç”¨

### é•œåƒå¤§å°

- **åŸºç¡€é•œåƒ**: Python 3.11-slim (~150MB)
- **ç³»ç»ŸåŒ…**: Nginx, Supervisor (~50MB)
- **Python ä¾èµ–**: FastAPI, Uvicorn ç­‰ (~100MB)
- **å‰ç«¯æ„å»ºäº§ç‰©**: Vue åº”ç”¨ (~5MB)
- **æ€»è®¡**: ~500MB

### è¿è¡Œæ—¶èµ„æº

- **CPU**: å»ºè®® 1-2 æ ¸
- **å†…å­˜**: å»ºè®® 512MB-1GB
- **ç£ç›˜**: 
  - ç³»ç»Ÿ: ~500MB
  - æ•°æ®: æ ¹æ®ç”Ÿæˆçš„å›¾ç‰‡æ•°é‡

## ğŸ” ç›‘æ§å’Œè°ƒè¯•

### æŸ¥çœ‹è¿›ç¨‹çŠ¶æ€

```bash
docker exec volcengine-app supervisorctl status
```

è¾“å‡ºç¤ºä¾‹ï¼š
```
nginx                            RUNNING   pid 25, uptime 0:05:12
uvicorn                          RUNNING   pid 24, uptime 0:05:12
```

### æŸ¥çœ‹æ—¥å¿—

```bash
# å®¹å™¨æ€»æ—¥å¿—
docker logs volcengine-app

# Supervisor ä¸»æ—¥å¿—
docker exec volcengine-app cat /var/log/supervisor/supervisord.log

# åç«¯æ—¥å¿—
docker exec volcengine-app tail -f /var/log/supervisor/uvicorn.log

# Nginx æ—¥å¿—
docker exec volcengine-app tail -f /var/log/supervisor/nginx.log
docker exec volcengine-app tail -f /var/log/nginx/access.log
docker exec volcengine-app tail -f /var/log/nginx/error.log
```

### è¿›å…¥å®¹å™¨è°ƒè¯•

```bash
docker exec -it volcengine-app bash

# åœ¨å®¹å™¨å†…ï¼š
ps aux                           # æŸ¥çœ‹è¿›ç¨‹
netstat -tlnp                    # æŸ¥çœ‹ç«¯å£ç›‘å¬
curl http://localhost:8000/health  # æµ‹è¯•åç«¯
curl http://localhost:80/health    # æµ‹è¯• Nginx
supervisorctl status             # æŸ¥çœ‹æœåŠ¡çŠ¶æ€
supervisorctl restart uvicorn    # é‡å¯åç«¯
supervisorctl restart nginx      # é‡å¯ Nginx
```

## ğŸ†š ä¸åˆ†ç¦»å¼æ¶æ„å¯¹æ¯”

### å…¨æ ˆå•é•œåƒ

**ä¼˜åŠ¿**:
- âœ… éƒ¨ç½²ç®€å•ï¼Œåªéœ€ä¸€ä¸ªå®¹å™¨
- âœ… é…ç½®ç®€å•ï¼Œæ— éœ€å®¹å™¨é—´é€šä¿¡
- âœ… èµ„æºå ç”¨ç›¸å¯¹è¾ƒå°‘
- âœ… é€‚åˆå°å‹éƒ¨ç½²ã€å¼€å‘ã€æµ‹è¯•

**åŠ£åŠ¿**:
- âŒ æ— æ³•ç‹¬ç«‹æ‰©å±•å‰åç«¯
- âŒ å‡çº§éœ€è¦é‡å»ºæ•´ä¸ªé•œåƒ
- âŒ ä¸é€‚åˆå¤§è§„æ¨¡ç”Ÿäº§ç¯å¢ƒ

### åˆ†ç¦»å¼æ¶æ„

**ä¼˜åŠ¿**:
- âœ… å¯ä»¥ç‹¬ç«‹æ‰©å±•æœåŠ¡
- âœ… å‰åç«¯å¯ç‹¬ç«‹æ›´æ–°
- âœ… æ›´ç¬¦åˆå¾®æœåŠ¡æ¶æ„
- âœ… é€‚åˆç”Ÿäº§ç¯å¢ƒ

**åŠ£åŠ¿**:
- âŒ éƒ¨ç½²ç›¸å¯¹å¤æ‚
- âŒ éœ€è¦ç®¡ç†å¤šä¸ªå®¹å™¨
- âŒ éœ€è¦é…ç½®ç½‘ç»œ

## ğŸ¯ é€‚ç”¨åœºæ™¯

### æ¨èä½¿ç”¨å…¨æ ˆå•é•œåƒ

- ä¸ªäººé¡¹ç›®æˆ–å°å‹åº”ç”¨
- å¼€å‘å’Œæµ‹è¯•ç¯å¢ƒ
- å¿«é€ŸåŸå‹éªŒè¯
- ç®€å•çš„ç”Ÿäº§éƒ¨ç½²
- å®¹å™¨åŒ–å­¦ä¹ 

### æ¨èä½¿ç”¨åˆ†ç¦»å¼æ¶æ„

- ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
- éœ€è¦é«˜å¯ç”¨æ€§
- éœ€è¦ç‹¬ç«‹æ‰©å±•
- å¤§å‹ä¼ä¸šåº”ç”¨
- å¾®æœåŠ¡æ¶æ„

## ğŸ” å®‰å…¨è€ƒè™‘

### å®¹å™¨å†…å®‰å…¨

1. **è¿›ç¨‹æƒé™**
   - Nginx ä»¥ www-data ç”¨æˆ·è¿è¡Œ
   - Uvicorn ä»¥ root è¿è¡Œï¼ˆå¯æ”¹è¿›ä¸ºé rootï¼‰

2. **æ–‡ä»¶æƒé™**
   - å‰ç«¯æ–‡ä»¶: www-data æƒé™
   - åç«¯ä»£ç : root æƒé™
   - æ•°æ®ç›®å½•: 755 æƒé™

3. **ç½‘ç»œéš”ç¦»**
   - åç«¯ä»…ç›‘å¬ localhost:8000
   - ä»… Nginx 80 ç«¯å£å¯¹å¤–æš´éœ²

### éƒ¨ç½²å®‰å…¨

1. **ç¯å¢ƒå˜é‡**
   - ä½¿ç”¨ `.env` æ–‡ä»¶
   - ä¸åœ¨é•œåƒä¸­ç¡¬ç¼–ç å‡­è¯

2. **HTTPS**
   - å»ºè®®ä½¿ç”¨åå‘ä»£ç†æ·»åŠ  SSL
   - æˆ–ä½¿ç”¨ Caddy è‡ªåŠ¨ HTTPS

3. **è®¿é—®æ§åˆ¶**
   - é…ç½®é˜²ç«å¢™è§„åˆ™
   - é™åˆ¶è®¿é—®æ¥æº

## ğŸ“ æ€»ç»“

å…¨æ ˆå•é•œåƒç‰ˆæœ¬é€šè¿‡ä»¥ä¸‹æŠ€æœ¯å®ç°ï¼š

1. **å¤šé˜¶æ®µæ„å»º** - åˆ†ç¦»æ„å»ºå’Œè¿è¡Œç¯å¢ƒ
2. **Supervisor** - ç®¡ç†å¤šä¸ªè¿›ç¨‹
3. **Nginx** - é«˜æ•ˆçš„é™æ€æ–‡ä»¶æœåŠ¡å’Œåå‘ä»£ç†
4. **æœ¬åœ°é€šä¿¡** - ä½¿ç”¨ localhost é€šä¿¡ï¼Œæ— éœ€ç½‘ç»œé…ç½®

è¿™ç§æ¶æ„é€‚åˆç®€å•éƒ¨ç½²åœºæ™¯ï¼Œæä¾›äº†è‰¯å¥½çš„æ€§èƒ½å’Œæ˜“ç”¨æ€§å¹³è¡¡ã€‚

---

**ç›¸å…³æ–‡æ¡£**:
- [å¿«é€Ÿéƒ¨ç½²æŒ‡å—](QUICK_DEPLOY.md)
- [ä½¿ç”¨æ–‡æ¡£](README.fullstack.md)
- [ä¸»æ–‡æ¡£](README.md)
