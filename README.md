# Volcengine Image Generation Docker Application — Research & Implementation Plan

## 1. 背景与目标
- **业务目标**：构建一个可容器化部署的 Web 应用，集成火山引擎图像生成（生图）接口，实现文本生成图像以及参数配置、任务追踪、结果管理等功能。
- **交付范围**：给出完整的工程化方案，包括容器架构、后台与前端模块划分、与火山引擎接口交互的流程、安全与配置策略、后续演进与测试计划。
- **参考文档**：
  - [文档 1：图像生成 API 概述与调用说明](https://www.volcengine.com/docs/82379/1541523)
  - [文档 2：API 认证签名规范与请求示例](https://www.volcengine.com/docs/82379/1824121)

## 2. 火山引擎生图 API 调研摘要
> 以下内容以官方文档为准，开发阶段需再次核对具体字段与限制。

### 2.1 服务定位
- 文档 1541523 描述了 ImageX 图像生成/编辑能力（文本生成图像、图像变体等），提供 RESTful OpenAPI。
- 文档 1824121 详细说明了 API 调用时的公共参数、鉴权方式（AK/SK + HMAC-SHA256 签名）、错误码与请求示例。

### 2.2 接入方式
- **域名**：默认 `https://open.volcengineapi.com`。
- **Action**：例如 `SubmitImageGenerateJob`（名称以实际文档为准）。
- **版本**：文档中常见 `Version=2022-08-31` 或类似时间戳格式。
- **接口风格**：`POST /?Action=xxx&Version=xxx`，Body 为 JSON。

### 2.3 请求参数（示例）
- `Model`：使用的文生图模型，如 `imagex.stable-diffusion-xl`。
- `Prompt` / `NegativePrompt`：正向与反向提示词。
- `CfgScale`、`Steps`、`Seed`：控制生成质量与一致性的参数。
- `Style` / `ImageSize`：预设风格、分辨率（需符合文档限定）。
- `CallbackURL`：可选，生成完成后回调。

### 2.4 响应结构（示例）
- `ResponseMetadata`：请求 ID、错误码、错误信息。
- `Result`：包含任务 ID、生成状态、图像 URL（可能位于火山引擎的临时存储域名中）。
- **异步特性**：接口可能返回任务 ID，需轮询 `GetImageGenerateResult` 之类的查询接口。

### 2.5 限制与配额
- **QPS/并发**：需查询文档及账户配额；若无明确限制，可预留自适应限流逻辑。
- **鉴权有效期**：签名在请求发送时即时验证，不支持复用。
- **网络环境**：容器需能访问公网；如部署在 VPC 内，请配置 NAT 或代理。

### 2.6 安全要求
- AK/SK 必须保存在安全存储（容器内通过环境变量或挂载的密钥文件）。
- 对外提供 API 时需隐藏 AK/SK，只在服务端签名。

## 3. 系统架构规划

### 3.1 总体架构
```
┌────────────────────────────────────────────────┐
│                   Docker Compose               │
│                                                │
│  ┌──────────────┐    ┌────────────────────┐    │
│  │  Frontend    │    │  Backend (API)     │    │
│  │  (React/TS)  │<-->|  FastAPI / Flask   │<--┐│
│  └──────────────┘    └────────────────────┘  ││
│          ▲                ▲      ▲           ││
│          │                │      │           ││
│  ┌───────┴───────┐   ┌────┴────┐ │           ││
│  │Static Storage │   │Task Queue│ │           ││
│  │(S3/OSS/local) │   │(Redis)   │ │           ││
│  └──────────────┘   └──────────┘ │           ││
│                                  │           ││
│                         ┌────────┴────┐      ││
│                         │Volcengine   │<─────┘│
│                         │Image API    │        │
│                         └─────────────┘        │
└────────────────────────────────────────────────┘
```

### 3.2 模块说明
1. **Backend Service**（建议使用 Python FastAPI）：
   - 封装火山引擎 API 的签名逻辑与请求发送。
   - 提供 REST API（任务创建、任务状态查询、历史列表、图片下载等）。
   - 管理任务状态：提交 -> 等待 -> 成功/失败。
   - 若接口异步，结合 Redis 记录任务信息。
   - 提供回调处理（若使用官方回调模式）。

2. **Frontend Web UI**（React + Chakra UI / Ant Design 等）：
   - 文生图表单：提示词输入、负面词、风格、分辨率等。
   - 任务列表：显示状态、进度条、失败原因。
   - 结果展示：缩略图瀑布流，支持下载、收藏、复制链接。
   - 用户体验优化：loading、错误提示、操作指引。

3. **Task Queue & Scheduler**（可选增强）：
   - 若后台需处理异步轮询，可将任务推入 Redis，后台 Celery/ RQ worker 定期向火山引擎查询任务状态。
   - 小规模场景可直接由 FastAPI 后台定时轮询（APScheduler）。

4. **Storage 策略**：
   - 短期：直接使用火山引擎返回的临时 URL。
   - 中长期：下载图片存储至本地磁盘（挂载卷）或对象存储（如火山引擎 TOS），并生成访问链接。

5. **Configuration 管理**：
   - 使用 `.env` 文件提供 `VOLCENGINE_ACCESS_KEY`、`SECRET_KEY`、`SERVICE_ID`、`REGION`、`MODEL_ID` 等配置。
   - Docker Compose 中通过环境变量向容器注入。

6. **日志与监控**：
   - Backend 使用结构化日志（JSON），记录请求耗时、错误码。
   - 通过 Prometheus 导出基本 metrics（QPS、错误率、任务耗时）。
   - 前端捕获并上报异常到后台（可扩展 Sentry）。

### 3.3 Docker 化设计
- **多阶段构建**：
  - Backend：基于 `python:3.11-slim`，第一阶段安装依赖；第二阶段复制代码并仅保留运行所需文件。
  - Frontend：基于 `node:20` 进行构建，将产物复制到 `nginx:alpine` 作为静态站点。
- **Docker Compose**：
  - `frontend`（端口 3000/80）：serve 静态资源。
  - `backend`（端口 8000）：Uvicorn/Gunicorn + FastAPI。
  - `redis`（可选）：任务状态存储。
- **网络**：内部使用 Docker 网络，前端通过 Nginx 反向代理 API 请求（`/api` 转发至 backend）。
- **配置文件**：
  - `docker-compose.yml`
  - `backend/Dockerfile`
  - `frontend/Dockerfile`
  - `.env.example`

### 3.4 安全与合规
- `.env` 不纳入版本管理，使用 `.env.example` 提供模板。
- 在容器部署场景中，建议通过 Kubernetes Secret / Docker Secret 管理 AK/SK。
- 后端需实现速率限制与输入校验，避免滥用。
- 审计日志：记录访问者、请求参数（敏感信息脱敏）。

## 4. 功能列表与用户流程

### 4.1 核心功能
1. **文本生成图像**：用户输入提示词 -> 后端调用 API -> 返回任务 ID -> 前端轮询直至完成。
2. **任务管理**：
   - 查看当前与历史任务。
   - 单个任务详情：参数、创建时间、状态、错误信息。
3. **图片预览与下载**：支持多张图片展示、原图下载、复制链接。
4. **参数模板**：保存常用提示词、风格；一键复用。
5. **多模型支持**（如文档中提供多个模型 ID）。

### 4.2 增强功能（可迭代）
- 用户身份管理（登录、配额限制）。
- 任务标签、收藏夹。
- 批量生图与批量下载。
- 图片编辑功能（文档若支持图生图、局部重绘）。

### 4.3 用户体验要求
- 响应式布局，适配桌面与移动设备。
- 直观的加载状态、错误提示与重试入口。
- 对提示词提供提示（支持 Markdown、示例）
- 生成历史按时间轴展示。

## 5. 开发实施计划

| 阶段 | 子任务 | 说明 |
|------|--------|------|
| 需求冻结 | 明确模型、接口、参数范围 | 与产品/运营确认业务需求、每日配额、收费策略 |
| 架构设计 | 确定技术栈、模块划分、数据流 | 产出接口设计文档、ER 图、组件图 |
| 开发准备 | 初始化仓库、基础工程 | 包括 Monorepo 结构、CI/CD、Lint/Formatting 规范 |
| 后端开发 | 封装鉴权签名、API 客户端 | 实现任务创建、任务查询、图片下载接口 |
|         | 构建 REST API | FastAPI 路由、Pydantic 校验、异常处理 |
| 队列 & 调度 | 引入 Redis + Celery/RQ | 处理异步轮询、回调逻辑 |
| 前端开发 | UI、状态管理、API 对接 | React + Zustand/Redux，组件库选型 |
| 集成交付 | Dockerfile、docker-compose | 提供一键启动脚本、文档 |
| 测试阶段 | 单元测试、集成测试、端到端测试 | 利用 pytest + Playwright（可选） |
| 验收上线 | UAT、性能测试、监控告警配置 | 观测日志、错误率、稳定性 |

## 6. 测试与验证策略
- **单元测试**：
  - 后端：签名逻辑、请求参数校验、错误码解析。
  - 前端：组件快照、表单校验。
- **集成测试**：
  - 使用 Mock Server 模拟火山引擎响应；实际调用需使用预发帐号。
- **端到端测试**：
  - 使用 Playwright/Selenium 自动填写表单、触发生成、校验结果显示。
- **性能测试**：
  - 确定可承载的并发任务上限（Locust/JMeter）。
- **监控校验**：
  - 通过 Prometheus + Grafana 验证指标采集与告警。

## 7. 运维与部署建议
- **环境区分**：Dev / Staging / Prod，均使用 Docker Compose 或 K8s 部署。
- **CI/CD**：
  - GitHub Actions / GitLab CI 进行单测、构建与镜像推送。
  - 采用语义化版本，镜像命名 `registry/project/image-gen-frontend:tag`。
- **日志收集**：
  - 后端日志输出到 stdout，配合 ELK/EFK。
- **指标与告警**：
  - 自建 Prometheus 或使用火山引擎观测平台。
- **备份策略**：
  - 对存储的生成图片定期备份，保留元数据。

## 8. 风险与待确认项
- **接口稳定性**：需确认 API 是否频繁升级变化。
- **费用与配额**：图像生成可能按量计费，需防止滥用。
- **版权/合规**：对生成内容的审核策略（可选加人工审核）。
- **网络延迟**：异地部署时可能影响生成速度；考虑使用同区域资源。
- **回调机制**：若使用回调需开放公网地址并验证安全性（签名/Token）。

## 9. 下一步行动
1. 跟进火山引擎控制台获取 AK/SK、Service ID、模型 ID。
2. 核对文档中的接口路径、参数、示例，并整理成配置常量。
3. 起草 API 封装模块（Python SDK 或直接 requests）。
4. 设计前后端 API 契约（OpenAPI/Swagger 文档）。
5. 初始仓库：创建 `backend`, `frontend`, `infrastructure` 目录及基础依赖。
6. 编写 `.env.example`、`Makefile`（一键运行 `docker compose up`）。
7. 进入开发实现阶段。

---
本方案总结了构建容器化火山引擎生图应用所需的技术研究与架构规划，为后续实现提供基础。后续开发中应持续与产品、设计、运维协作，确保功能、美观度与稳定性达到预期。
