name: Docker Build, Push and Release

on:
  push:
    tags:
      - 'v*.*.*'  # è§¦å‘æ¡ä»¶ï¼šæŽ¨é€ç‰ˆæœ¬æ ‡ç­¾ï¼Œå¦‚ v1.0.0
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      version:
        description: 'Release version (e.g., 1.0.0)'
        required: true
        default: '1.0.0'

env:
  REGISTRY: ghcr.io
  BACKEND_IMAGE_NAME: ${{ github.repository }}-backend
  FRONTEND_IMAGE_NAME: ${{ github.repository }}-frontend

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract version from tag or input
        id: get_version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/v}
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Version: ${VERSION}"

      - name: Extract metadata for backend
        id: meta-backend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE_NAME }}
          tags: |
            type=semver,pattern=v{{version}},value=${{ steps.get_version.outputs.version }}
            type=semver,pattern=v{{major}}.{{minor}},value=${{ steps.get_version.outputs.version }}
            type=semver,pattern=v{{major}},value=${{ steps.get_version.outputs.version }}
            type=semver,pattern={{version}},value=${{ steps.get_version.outputs.version }}
            type=semver,pattern={{major}}.{{minor}},value=${{ steps.get_version.outputs.version }}
            type=semver,pattern={{major}},value=${{ steps.get_version.outputs.version }}
            type=raw,value=latest

      - name: Extract metadata for frontend
        id: meta-frontend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.FRONTEND_IMAGE_NAME }}
          tags: |
            type=semver,pattern=v{{version}},value=${{ steps.get_version.outputs.version }}
            type=semver,pattern=v{{major}}.{{minor}},value=${{ steps.get_version.outputs.version }}
            type=semver,pattern=v{{major}},value=${{ steps.get_version.outputs.version }}
            type=semver,pattern={{version}},value=${{ steps.get_version.outputs.version }}
            type=semver,pattern={{major}}.{{minor}},value=${{ steps.get_version.outputs.version }}
            type=semver,pattern={{major}},value=${{ steps.get_version.outputs.version }}
            type=raw,value=latest

      - name: Build and push backend image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ${{ steps.meta-backend.outputs.tags }}
          labels: ${{ steps.meta-backend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            PYTHON_VERSION=3.11

      - name: Build and push frontend image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./nginx/Dockerfile
          push: true
          tags: ${{ steps.meta-frontend.outputs.tags }}
          labels: ${{ steps.meta-frontend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NODE_VERSION=20
            NGINX_VERSION=1.27-alpine

      - name: Generate release notes
        id: release_notes
        run: |
          cat <<EOF > release_notes.md
          ## ðŸŽ‰ Volcengine å›¾åƒç”Ÿæˆå™¨ v${{ steps.get_version.outputs.version }}

          ### ðŸ“¦ Docker é•œåƒ

          æœ¬æ¬¡å‘å¸ƒåŒ…å«ä»¥ä¸‹ Docker é•œåƒï¼š

          #### åŽç«¯æœåŠ¡ (Backend)
          ```bash
          docker pull ${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE_NAME }}:${{ steps.get_version.outputs.version }}
          ```

          #### å‰ç«¯æœåŠ¡ (Frontend + Nginx)
          ```bash
          docker pull ${{ env.REGISTRY }}/${{ env.FRONTEND_IMAGE_NAME }}:${{ steps.get_version.outputs.version }}
          ```

          ### ðŸš€ å¿«é€Ÿéƒ¨ç½²

          1. å…‹éš†ä»“åº“æˆ–ä¸‹è½½ docker-compose.yml
          2. åˆ›å»º .env æ–‡ä»¶å¹¶é…ç½®ç«å±±å¼•æ“Žå‡­è¯ï¼ˆå¯é€‰ï¼‰
          3. æ›´æ–° docker-compose.yml ä¸­çš„é•œåƒç‰ˆæœ¬ï¼š
          ```yaml
          services:
            backend:
              image: ${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE_NAME }}:${{ steps.get_version.outputs.version }}
            frontend:
              image: ${{ env.REGISTRY }}/${{ env.FRONTEND_IMAGE_NAME }}:${{ steps.get_version.outputs.version }}
          ```
          4. å¯åŠ¨æœåŠ¡ï¼š
          ```bash
          docker-compose up -d
          ```
          5. è®¿é—® http://localhost:3000

          ### âœ¨ ä¸»è¦ç‰¹æ€§

          - ðŸ–¼ï¸ **æ–‡ç”Ÿå›¾**ï¼šæ ¹æ®æ–‡æœ¬æç¤ºè¯ç”Ÿæˆé«˜è´¨é‡å›¾åƒ
          - ðŸŽ¨ **å›¾ç”Ÿå›¾**ï¼šå¯¹çŽ°æœ‰å›¾ç‰‡è¿›è¡Œ AI è½¬æ¢å’Œé£Žæ ¼è¿ç§»
          - ðŸ“š **åŽ†å²è®°å½•**ï¼šæµè§ˆå’Œç®¡ç†æ‰€æœ‰ç”Ÿæˆçš„å›¾ç‰‡
          - ðŸ’Ž **çŽ°ä»£åŒ–ç•Œé¢**ï¼šåŸºäºŽ Vue 3 å’Œ Element Plus çš„å“åº”å¼ UI
          - ðŸ³ **å®¹å™¨åŒ–éƒ¨ç½²**ï¼šå®Œæ•´çš„ Docker æ”¯æŒï¼Œå¼€ç®±å³ç”¨

          ### ðŸ“‹ ç³»ç»Ÿè¦æ±‚

          - Docker 20.10+
          - Docker Compose 2.0+
          - ç«å±±å¼•æ“Žè´¦å·ï¼ˆDemo æ¨¡å¼å¯é€‰ï¼‰

          ### ðŸ“– æ–‡æ¡£

          å®Œæ•´æ–‡æ¡£è¯·æŸ¥çœ‹ï¼š[README.md](https://github.com/${{ github.repository }}/blob/main/README.md)

          ---
          æž„å»ºæ—¶é—´ï¼š$(date -u '+%Y-%m-%d %H:%M:%S UTC')
          EOF
          cat release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.get_version.outputs.version }}
          name: Release v${{ steps.get_version.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update docker-compose.yml for release
        run: |
          cat > docker-compose.release.yml << EOF
          # Docker Compose configuration for Volcengine Image Generator
          # Release version: v${{ steps.get_version.outputs.version }}
          # 
          # Usage:
          #   1. Copy this file to docker-compose.yml
          #   2. Create .env file with your Volcengine credentials (optional)
          #   3. Run: docker-compose up -d
          
          services:
            backend:
              image: ${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE_NAME }}:${{ steps.get_version.outputs.version }}
              container_name: volcengine-backend
              restart: unless-stopped
              env_file:
                - .env
              environment:
                - PYTHONUNBUFFERED=1
              volumes:
                - ./data:/app/data
                - backend-cache:/root/.cache
              ports:
                - "8000:8000"
              networks:
                - volcengine-net
              healthcheck:
                test: ["CMD", "python", "-c", "import urllib.request, sys; sys.exit(0 if urllib.request.urlopen('http://localhost:8000/health').status == 200 else 1)"]
                interval: 30s
                timeout: 10s
                retries: 3
                start_period: 40s
          
            frontend:
              image: ${{ env.REGISTRY }}/${{ env.FRONTEND_IMAGE_NAME }}:${{ steps.get_version.outputs.version }}
              container_name: volcengine-frontend
              restart: unless-stopped
              depends_on:
                backend:
                  condition: service_healthy
              ports:
                - "3000:80"
              networks:
                - volcengine-net
              healthcheck:
                test: ["CMD-SHELL", "wget --quiet --tries=1 --spider http://localhost:80 || exit 1"]
                interval: 30s
                timeout: 10s
                retries: 3
                start_period: 40s
          
          volumes:
            backend-cache:
              driver: local
          
          networks:
            volcengine-net:
              driver: bridge
          EOF

      - name: Upload docker-compose file to release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.get_version.outputs.version }}
          files: |
            docker-compose.release.yml
            .env.example
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "## ðŸŽ‰ å‘å¸ƒæˆåŠŸï¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ é•œåƒä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ç‰ˆæœ¬**: v${{ steps.get_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**åŽç«¯é•œåƒ**:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE_NAME }}:${{ steps.get_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**å‰ç«¯é•œåƒ**:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ env.REGISTRY }}/${{ env.FRONTEND_IMAGE_NAME }}:${{ steps.get_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— é“¾æŽ¥" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [æŸ¥çœ‹ Release](https://github.com/${{ github.repository }}/releases/tag/v${{ steps.get_version.outputs.version }})" >> $GITHUB_STEP_SUMMARY
          echo "- [åŽç«¯é•œåƒ](https://github.com/${{ github.repository }}/pkgs/container/${{ github.repository }}-backend)" >> $GITHUB_STEP_SUMMARY
          echo "- [å‰ç«¯é•œåƒ](https://github.com/${{ github.repository }}/pkgs/container/${{ github.repository }}-frontend)" >> $GITHUB_STEP_SUMMARY
